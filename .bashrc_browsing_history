# ~/.bashrc_browsing_history
#
# Writing an overlayer of 'cd' with a browsing history. Moreover 'ls' follows
# 'cd' if possible and relevant.
# usage : 'cd -' go to the previous working directory (wd), 
#         'cd +' go to the next one wd, 
#         'cd :<i>' go to the <i>th one wd in the browsing history,
#         'bhistory' show the current browsing history.
################################################################################

# Environment variables
declare -a BHIST_DIR=([0]="$PWD")
declare -i BHIST_CUR_INDEX=0
declare -i BHIST_LEN=1

##
# Description: Show the browsing history in your current Bash Shell.
__bhist_bhistory(){

   for i in ${!BHIST_DIR[*]}; do
      if test $i -eq $BHIST_CUR_INDEX; then
         echo -n "*"
      else
         echo -n " "
      fi
      echo "$i ${BHIST_DIR[$i]}"
   done
}

##
# Description: Trigger action after a cd to complete browsing history 
#              and show content of a folder (with 'ls'), if it's relevant.
# Parameter:
#  $1: the repository parameter of 'cd' ("$HOME", "/etc/", "", ".", "..", ...)
#      with new metacharacter ("-", "+", ":<i>").
__bhist_changedir(){

   local saved_index=$BHIST_CUR_INDEX
   local modify_history=true

   # go to the previous working directory
   if test "$1" = "-"; then
      if test -d '-'; then
         echo "WARNING: 'cd -', folder '-' exists, go into this with 'cd ./-'."
      fi
      if test $BHIST_CUR_INDEX -eq 0; then
         echo "ERROR: 'cd -', impossible out of range browsing history."
         return 1   
      fi
      BHIST_CUR_INDEX=$(($BHIST_CUR_INDEX-1))
      rep=${BHIST_DIR[$BHIST_CUR_INDEX]}
      modify_history=false
      
   # go to the next working directory
   elif test "$1" = "+"; then
      if test -d '+'; then
         echo "WARNING: 'cd +', folder '+' exists, go into this with 'cd ./+'."
      fi
      if test $BHIST_CUR_INDEX -eq $(($BHIST_LEN-1)); then
         echo "ERROR: 'cd +', impossible out of range browsing history."
         return 1
      fi
      BHIST_CUR_INDEX=$(($BHIST_CUR_INDEX+1))
      rep="${BHIST_DIR[$BHIST_CUR_INDEX]}"
      modify_history=false
      
   # choose the repository
   elif [[ "$1" =~ ^:[1-9]*[0-9]$ ]]; then
      i=$(echo "$1" | sed 's/^://')
      if test -d ':$i'; then
         echo "WARNING: 'cd :$i', folder ':$i' exists, go into this with 'cd ./:$i'."   
      fi
      if test $i -lt 0 -o $i -ge $BHIST_LEN; then
         echo "ERROR: 'cd :$i', impossible out of range browsing history."
         return 1   
      fi
      rep="${BHIST_DIR[$i]}"
      BHIST_CUR_INDEX=$i
      rep="${BHIST_DIR[$BHIST_CUR_INDEX]}"
      modify_history=false
      
   # traditional action for a 'cd'
   elif test "$1" = ""; then
      rep="$HOME"
   else
      rep="$1"
   fi

   cd "$rep"
   
   if test "$?" -ne 0; then
      BHIST_CUR_INDEX="$saved_index"
      return 1
   fi
   
   if $modify_history; then
      if test "$PWD" != "${BHIST_DIR[$(($BHIST_LEN-1))]}"; then
         BHIST_DIR[$BHIST_LEN]="$PWD"
         BHIST_LEN=$(($BHIST_LEN+1))
         if test $BHIST_CUR_INDEX -eq $saved_index; then
            BHIST_CUR_INDEX=$BHIST_LEN
         fi
      fi
   fi

   # 'ls' follows 'cd' if possible and relevant
   if test $(ls -C | wc -l) -le 4; then
      ls --color=auto
   fi
}

# aliases
alias cd="__bhist_changedir $1"
alias bhistory="__bhist_bhistory"
alias chistory="history"
