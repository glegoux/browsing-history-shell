# ~/.bashrc_browsing_history
#
# Writing an overlayer of 'cd' with a browsing history. Moreover 'ls' follows
# 'cd' if possible and relevant.
# usage : 'cd -' go to the previous working directory (wd), 
#         'cd +' go to the next one wd, 
#         'cd :<i>' go to the <i>th one wd in the browsing history,
#         'bhistory' to show it the current browsing history.
################################################################################

# Environment variables
declare -a BHIST_DIR=([0]="$PWD")
declare -i BHIST_CUR=0
declare -i BHIST_LEN=0

##
# Description: Show the browsing history in your current Bash Shell.
__bhist_bhistory(){

   for i in ${!BHIST_DIR[*]}; do
      if test $i -eq $BHIST_CUR; then
         echo -n "*"
      else
         echo -n " "
      fi
      echo "$i ${BHIST_DIR[$i]}"
   done
}

##
# Description: Trigger action after a cd to complete browsing history 
#              and show content of a folder (with 'ls'), if it's relevant.
# Parameter:
#  $1: the repository parameter of 'cd' ("$HOME", "/etc/", "", ".", "..", ...)
#      with new metacharacter ("-", "+", ":<i>").
__bhist_changedir(){

   local saved_bhist_cur=$BHIST_CUR
   local modify_history=true

   # go to the previous working directory
   if test "$1" = "-"; then
      if test $BHIST_CUR -gt 0; then
         BHIST_CUR=$(($BHIST_CUR-1))
      fi
      rep=${BHIST_DIR[$BHIST_CUR]}
      modify_history=false
      
   # go to the next working directory
   elif test "$1" = "+"; then
      if test $BHIST_CUR -lt $BHIST_LEN; then
         BHIST_CUR=$(($BHIST_CUR+1))
      fi
      rep="${BHIST_DIR[$BHIST_CUR]}"
      modify_history=false
      
   # choose the repository
   elif [[ "$1" =~ ^:[1-9]*[0-9]$ ]]; then
      i=$(echo "$1" | sed 's/^://')
      if test $i -ge 0 -o $i -le $BHIST_LEN; then
         rep="${BHIST_DIR[$i]}"
         BHIST_CUR=$i
      fi
      rep="${BHIST_DIR[$BHIST_CUR]}"
      modify_history=false
      
   # traditional action for a 'cd'
   elif test "$1" = ""; then
      rep="$HOME"
   else
      rep="$1"
   fi

   cd "$rep"
   
   if test "$?" -ne 0; then
      BHIST_CUR="$saved_bhist_cur"
      return 1
   fi
   
   if $modify_history; then
      if test "$PWD" != "${BHIST_DIR[$saved_bhist_cur]}"; then
         BHIST_LEN=$(($BHIST_LEN+1))
         BHIST_DIR[$BHIST_LEN]="$PWD"
         if test $BHIST_CUR -eq $saved_bhist_cur; then
            BHIST_CUR=$BHIST_LEN
         fi
      fi
   fi

   # 'ls' follows 'cd' if possible and relevant
   if test $(ls -C | wc -l) -le 4; then
      ls --color=auto
   fi
}

# aliases
alias cd="__bhist_changedir $1"
alias bhistory="__bhist_bhistory"
alias chistory="history"
