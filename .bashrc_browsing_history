# ~/.bashrc_browsing_history

# MANAGE CD & BROWSING HISTORY
# 'ls' folows 'cd' if possible and relevant.
# browsing history in $HIST_DIR (see command: bhistory)
# smart with 'cd -' (next), 'cd +' (previous),
# to browse in the browsing history.
# (/!\ no one folder should have a name with ':')

declare -a HIST_DIR=([0]="$PWD")
CUR=0
NUM=0

bhistory(){
   for i in ${!HIST_DIR[*]}; do
      if test $i -eq $CUR; then
         echo -n "*"
      else
         echo -n " "
      fi
      echo "$i ${HIST_DIR[$i]}"
   done
}

changedir(){
   CUR_SAUV=$CUR
   modify_history=true

   # previous
   if test "$1" = "-"; then
      if test $CUR -gt 0; then
         CUR=$(($CUR-1))
      fi
      rep=${HIST_DIR[$CUR]}
      modify_history=false
   # next
   elif test "$1" = "+"; then
      if test $CUR -lt $NUM; then
         CUR=$(($CUR+1))
      fi
      rep="${HIST_DIR[$CUR]}"
      modify_history=false
   # choose the repertory
   elif [[ "$1" =~ ^:[1-9]*[0-9]$ ]]; then
      i=$(echo "$1" | sed 's/^://')
      if test $i -ge 0 -o $i -le $NUM; then
         rep="${HIST_DIR[$i]}"
         CUR=$i
      fi
      rep="${HIST_DIR[$CUR]}"
      modify_history=false
   # traditional
   elif test "$1" = ""; then
      rep="$HOME"
   else
      rep="$1"
   fi

   cd "$rep"
   if test "$?" -ne 0; then
      CUR="$CUR_SAUV"
      return 1
   fi
   if $modify_history; then
      if test "$PWD" != "${HIST_DIR[$CUR_SAUV]}"; then
         NUM=$(($NUM+1))
         HIST_DIR[$NUM]="$PWD"
         if test $CUR -eq $CUR_SAUV; then
            CUR=$NUM
         fi
      fi
   fi

   if test $(ls -C | wc -l) -le 4; then
      ls --color=auto
   fi
}

alias chistory="history"
alias cd="changedir $1"
