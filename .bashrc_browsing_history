# ~/.bashrc_browsing_history
#
# Writing an overlayer of 'cd' with a browsing history. Moreover 'ls' follows
# 'cd' if possible and relevant.
# usage : 'cd -' go to the previous working directory (wd), 
#         'cd +' go to the next one wd, 
#         'cd :<i>' go to the <i>th one wd in the browsing history,
#         'bhistory' to show it the current browsing history.
################################################################################

# Environment variables
declare -a HIST_DIR=([0]="$PWD")
BHIST_CUR=0
BHIS_NUM=0

##
# Description: Show the browsing history in your current Bash Shell.
bhistory(){

   for i in ${!HIST_DIR[*]}; do
      if test $i -eq $BHIST_CUR; then
         echo -n "*"
      else
         echo -n " "
      fi
      echo "$i ${HIST_DIR[$i]}"
   done
}

##
# Description: Trigger action after a cd to complete browsing history 
#              and show content of a folder (with 'ls'), if it's relevant.
# Parameter:
#  $1: the repository parameter of 'cd' ("$HOME", "/etc/", "", ".", "..", ...)
#      with new metacharacter ("-", "+", ":<i>").
changedir(){

   local BHIST_CUR_SAUV=$BHIST_CUR
   local modify_history=true

   # go to the previous working directory
   if test "$1" = "-"; then
      if test $BHIST_CUR -gt 0; then
         BHIST_CUR=$(($BHIST_CUR-1))
      fi
      rep=${HIST_DIR[$BHIST_CUR]}
      modify_history=false
   # go to the next working directory
   elif test "$1" = "+"; then
      if test $BHIST_CUR -lt $BHIS_NUM; then
         BHIST_CUR=$(($BHIST_CUR+1))
      fi
      rep="${HIST_DIR[$BHIST_CUR]}"
      modify_history=false
   # choose the repository
   elif [[ "$1" =~ ^:[1-9]*[0-9]$ ]]; then
      i=$(echo "$1" | sed 's/^://')
      if test $i -ge 0 -o $i -le $BHIS_NUM; then
         rep="${HIST_DIR[$i]}"
         BHIST_CUR=$i
      fi
      rep="${HIST_DIR[$BHIST_CUR]}"
      modify_history=false
   # traditional action for a 'cd'
   elif test "$1" = ""; then
      rep="$HOME"
   else
      rep="$1"
   fi

   cd "$rep"
   
   if test "$?" -ne 0; then
      BHIST_CUR="$BHIST_CUR_SAUV"
      return 1
   fi
   
   if $modify_history; then
      if test "$PWD" != "${HIST_DIR[$BHIST_CUR_SAUV]}"; then
         BHIS_NUM=$(($BHIS_NUM+1))
         HIST_DIR[$BHIS_NUM]="$PWD"
         if test $BHIST_CUR -eq $BHIST_CUR_SAUV; then
            BHIST_CUR=$BHIS_NUM
         fi
      fi
   fi

   # 'ls' follows 'cd' if possible and relevant
   if test $(ls -C | wc -l) -le 4; then
      ls --color=auto
   fi
}

# aliases
alias chistory="history"
alias cd="changedir $1"
